# Group14
prompt_realæ˜¯è¦apikeyçš„ï¼Œmockæ˜¯æ¨¡æ‹Ÿaiå›ç­”ï¼Œå¯ä»¥å…ˆæµ‹è¯•æ¨¡æ‹Ÿè¿è¡Œã€‚
fastapiå¯¹æ¥é¡ºåˆ©ï¼Œéœ€è¦ä»˜è´¹è´¦æˆ·çš„apikey

æ–°ä¸Šä¼ çš„tenantchatbot_sprint2_LLMæ˜¯æ ¹æ®è€å¸ˆlangchainçš„ä»£ç æ”¹çš„ï¼Œæ€è·¯åº”è¯¥æ›´å…¨ã€‚
contract_rag_noapi_demoä¸éœ€è¦apikeyï¼Œä½†åŸºæœ¬æ²¡ç”¨ï¼Œå¯ä»¥å…ˆå¿½ç•¥ã€‚

ä½¿ç”¨æ–¹å¼ï¼š
ç¡®ä¿æ‚¨å®‰è£…äº†requirement.txtä¸­çš„æ‰€æœ‰çš„åŒ…,è¯·è‡ªå¤‡å¸¦æœ‰openai apiçš„.envæ–‡ä»¶
åœ¨å‘½ä»¤è¡Œä¸­è¾“å…¥cd /Users/....../Group14ï¼ˆè¿™å–å†³äºæ‚¨çš„ç”µè„‘è·¯å¾„ï¼‰
uvicorn backend.api:app --reload
åœ¨å¦ä¸€ä¸ªå‘½ä»¤è¡Œä¸­è¾“å…¥ streamlit run steeamlit_UI.pyå³å¯ä½¿ç”¨æˆ‘ä»¬çš„tenant chatbot

è¿™æ˜¯ä¸€ä¸ªéå¸¸å¥½çš„ä¸»æ„ã€‚ä¸º `llm2.py` å‡†å¤‡ä¸€ä¸ªæ¸…æ™°çš„READMEæ€»ç»“ï¼Œå¯ä»¥è®©æ‚¨çš„å‰ç«¯å’Œæ•°æ®åº“åŒå­¦ï¼ˆä»¥åŠæ‚¨è‡ªå·±ï¼‰çš„å·¥ä½œæ•ˆç‡å¤§å¤§æé«˜ã€‚

ä»¥ä¸‹æ˜¯ `llm2.py` ä¸­æ‰€æœ‰å…³é”®ç±»å’Œå‡½æ•°çš„æ€»ç»“ï¼Œä¸“ä¸ºæ‚¨çš„READMEè€Œè®¾è®¡ã€‚

---

llm2.py æ¨¡å—åŠŸèƒ½æ€»ç»“ (README)

æ¦‚è§ˆ

`llm2.py` æ˜¯æˆ‘ä»¬é¡¹ç›®çš„**æ ¸å¿ƒAIåç«¯**ã€‚å®ƒä¸åŒ…å«ä»»ä½•UIç•Œé¢ï¼Œä½†æä¾›äº†å‰ç«¯(`app.py`)æ‰€éœ€çš„æ‰€æœ‰â€œå¤§è„‘â€åŠŸèƒ½ã€‚å®ƒé‡‡ç”¨â€œæ··åˆå­˜å‚¨â€æ¶æ„ï¼š

* **PostgreSQL (æ•°æ®åº“):** ç”¨äºå­˜å‚¨ç»“æ„åŒ–æ•°æ®ï¼Œå¦‚èŠå¤©è®°å½• å’Œç»´ä¿®è¯·æ±‚ã€‚
* **æ–‡ä»¶ç³»ç»Ÿ (ChromaDB):** ç”¨äºå­˜å‚¨éç»“æ„åŒ–çš„AIçŸ¥è¯†åº“ï¼ˆå³åˆåŒçš„å‘é‡ï¼‰ã€‚

### 1. ğŸ¤– ä¸»è¦æ¥å£ (ä¾› `app.py` è°ƒç”¨)

å‰ç«¯åŒå­¦ï¼ˆ`app.py`ï¼‰**åªéœ€è¦**ç›´æ¥ä¸ä»¥ä¸‹ `TenantChatbot` ç±»å’Œ `create_user_vectorstore` å‡½æ•°äº¤äº’ã€‚

#### `class TenantChatbot`
è¿™æ˜¯AIæœºå™¨äººçš„ä¸»ç±»ã€‚

* **`__init__(self, llm_instance, tenant_id: str)`**
    * **åŠŸèƒ½ï¼š** åˆå§‹åŒ–ä¸€ä¸ª**ç‰¹å®šäºå•ä¸ªç”¨æˆ·**çš„èŠå¤©æœºå™¨äººå®ä¾‹ã€‚
    * **é‡è¦ï¼š** å¿…é¡»åœ¨ç”¨æˆ·â€œç™»å½•â€åï¼ˆå³æˆ‘ä»¬è·å¾—äº†`tenant_id`ï¼Œå¦‚é‚®ç®±ï¼‰æ‰èƒ½è°ƒç”¨æ­¤å‡½æ•°ã€‚
    * **å†…éƒ¨æ“ä½œï¼š** å®ƒä¼šè‡ªåŠ¨å®ä¾‹åŒ– `Psycopg2ChatHistory`ï¼Œä»æ•°æ®åº“åŠ è½½è¯¥ `tenant_id` çš„**æ°¸ä¹…èŠå¤©è®°å½•**ï¼Œå¹¶å°†å…¶æ³¨å…¥ `ConversationBufferWindowMemory` å’Œ `agent`ã€‚

* **`process_query(self, query: str, tenant_id: str) -> str`**
    * **åŠŸèƒ½ï¼š** **(è¿™æ˜¯å‰ç«¯å”¯ä¸€éœ€è¦è°ƒç”¨çš„â€œèŠå¤©â€å‡½æ•°)**ã€‚å®ƒæ¥æ”¶ç”¨æˆ·çš„åŸå§‹æé—®å­—ç¬¦ä¸²å’Œ `tenant_id`ï¼Œè¿”å›ä¸€ä¸ªAIå›ç­”çš„å­—ç¬¦ä¸²ã€‚
    * **å†…éƒ¨æ“ä½œï¼š** æ­¤å‡½æ•°æ˜¯â€œæ€»æŒ‡æŒ¥å®˜â€ï¼Œå®ƒä¼šè‡ªåŠ¨æ‰§è¡Œæ™ºèƒ½è·¯ç”±ï¼š
        1.  æ£€æŸ¥æ˜¯å¦ä¸º**ç»´ä¿®çŠ¶æ€æŸ¥è¯¢** (`status_keywords`) -> è°ƒç”¨ `check_maintenance_status`ã€‚
        2.  æ£€æŸ¥æ˜¯å¦ä¸º**æ–°ç»´ä¿®è¯·æ±‚** (`maintenance_keywords`) -> è¿”å›ç‰¹æ®Šä¿¡å· `MAINTENANCE_REQUEST_TRIGGERED`ã€‚
        3.  æ£€æŸ¥æ˜¯å¦ä¸º**åˆåŒRAGé—®ç­”** (`contract_keywords`) -> è°ƒç”¨åŠ¨æ€RAGã€‚
        4.  æ£€æŸ¥æ˜¯å¦ä¸º**è®¡ç®—** (`calc_keywords`) -> è°ƒç”¨ `agent`ã€‚
        5.  å¦åˆ™ï¼Œè§†ä¸º**S3é—²èŠ** -> è°ƒç”¨ `conversation.invoke`ï¼ˆå®ƒä¼šè‡ªåŠ¨è¯»/å†™æ•°æ®åº“ä¸­çš„èŠå¤©è®°å½•ï¼‰ã€‚

#### `create_user_vectorstore(tenant_id: str, pdf_file_path: str) -> Dict | None`
* **åŠŸèƒ½ï¼š** **(è¿™æ˜¯å‰ç«¯å”¯ä¸€éœ€è¦è°ƒç”¨çš„â€œæ–‡ä»¶ä¸Šä¼ â€å‡½æ•°)**ã€‚å®ƒå¤„ç†ç”¨æˆ·æ–°ä¸Šä¼ çš„PDFæ–‡ä»¶ã€‚
* **å‚æ•°ï¼š** `tenant_id` (ä¾‹å¦‚ "user@email.com") å’Œ `pdf_file_path` (Streamlitä¸Šä¼ åä¿å­˜çš„ä¸´æ—¶è·¯å¾„)ã€‚
* **å†…éƒ¨æ“ä½œï¼š**
    1.  ä½¿ç”¨ `PyPDFLoader` åŠ è½½PDFã€‚
    2.  è°ƒç”¨ `get_user_vector_store_path` è·å–å®‰å…¨çš„ã€å“ˆå¸Œè¿‡çš„æ–‡ä»¶å¤¹è·¯å¾„ã€‚
    3.  ä½¿ç”¨ `Chroma.from_documents` å°†PDFå‘é‡åŒ–å¹¶**ä¿å­˜åˆ°æ–‡ä»¶ç³»ç»Ÿ**ã€‚
    4.  **[æ”¹è¿›ä¸€]** è°ƒç”¨ `create_extraction_chain` å’Œ `ContractSummary` **ä¸»åŠ¨æå–åˆåŒæ‘˜è¦**ã€‚
* **è¿”å›å€¼ï¼š** è¿”å›ä¸€ä¸ªåŒ…å«æ‘˜è¦ï¼ˆç§Ÿé‡‘ã€æ—¥æœŸç­‰ï¼‰çš„**å­—å…¸**ï¼Œå¦‚æœå¤±è´¥åˆ™è¿”å› `None`ã€‚

---

### 2. ğŸ—ƒï¸ æ•°æ®åº“æ¥å£å‡½æ•° (ä¾› `app.py` å’Œå†…éƒ¨è°ƒç”¨)

è¿™äº›å‡½æ•°ç›´æ¥ä¸PostgreSQLæ•°æ®åº“äº¤äº’ã€‚

* **`log_maintenance_request(...)`**
    * **åŠŸèƒ½ï¼š** å°†ä¸€ä¸ª**æ–°**çš„ç»´ä¿®è¯·æ±‚å†™å…¥åˆ° `maintenance_requests` è¡¨ä¸­ã€‚
    * **è°ƒç”¨è€…ï¼š** `app.py`ï¼ˆåœ¨ç”¨æˆ·æäº¤ç»´ä¿®*è¡¨å•*åï¼‰ã€‚

* **`check_maintenance_status(tenant_id)`**
    * **åŠŸèƒ½ï¼š** **è¯»å–** `maintenance_requests` è¡¨ï¼Œè¿”å›è¯¥ `tenant_id` çš„æ‰€æœ‰ç»´ä¿®è¯·æ±‚åŠå…¶çŠ¶æ€ã€‚
    * **è°ƒç”¨è€…ï¼š** `TenantChatbot.process_query` (å†…éƒ¨è‡ªåŠ¨è°ƒç”¨)ã€‚

* **`get_db_connection()`**
    * **åŠŸèƒ½ï¼š** å†…éƒ¨è¾…åŠ©å‡½æ•°ï¼Œç”¨äºä» `DATABASE_URL` å»ºç«‹ `psycopg2` è¿æ¥ã€‚

---

### 3. ğŸ§  å†…éƒ¨çŸ¥è¯†åº“ (RAG) è¾…åŠ©å‡½æ•°

è¿™äº›å‡½æ•°æ”¯æŒRAGæ–‡ä»¶å¤„ç†ï¼Œä¸»è¦ç”±LLMåç«¯å†…éƒ¨ä½¿ç”¨ã€‚

* **`get_user_vector_store_path(tenant_id)`**
    * **åŠŸèƒ½ï¼š** **(å…³é”®å®‰å…¨ç‰¹æ€§)**ã€‚å°† `tenant_id`ï¼ˆä¾‹å¦‚ "user@email.com"ï¼‰è½¬æ¢ä¸ºä¸€ä¸ª**å®‰å…¨çš„ã€ç»è¿‡å“ˆå¸Œçš„**æ–‡ä»¶å¤¹åç§°ï¼ˆä¾‹å¦‚ "f1a7..."ï¼‰ï¼Œç”¨äºå­˜å‚¨ChromaDBã€‚
    * **å®ç°ï¼š** ä½¿ç”¨ `hashlib.sha256`ã€‚

* **`user_vector_store_exists(tenant_id)`**
    * **åŠŸèƒ½ï¼š** æ£€æŸ¥è¯¥ç”¨æˆ·çš„å‘é‡åº“ï¼ˆçŸ¥è¯†åº“ï¼‰æ˜¯å¦å·²å­˜åœ¨äºæ–‡ä»¶ç³»ç»Ÿã€‚

---

### 4. ğŸ› ï¸ å†…éƒ¨æ ¸å¿ƒç±»ä¸å·¥å…·

* **`class Psycopg2ChatHistory`**
    * **åŠŸèƒ½ï¼š** **(æ°¸ä¹…è®°å¿†çš„æ ¸å¿ƒ)**ã€‚è¿™æ˜¯ä¸€ä¸ªè‡ªå®šä¹‰ç±»ï¼Œå®ƒå®ç°äº†LangChainçš„ `BaseChatMessageHistory` æ¥å£ã€‚
    * **`messages` (å±æ€§)**ï¼šè¢« `ConversationBufferWindowMemory` è°ƒç”¨ï¼Œä» `chat_history` è¡¨**è¯»å–**å†å²è®°å½•ã€‚
    * **`add_message(message)`**ï¼šè¢« `ConversationBufferWindowMemory` è°ƒç”¨ï¼Œå°†æ–°æ¶ˆæ¯ï¼ˆHumanæˆ–AIï¼‰**å†™å…¥** `chat_history` è¡¨ã€‚

* **`class ContractSummary`**
    * **åŠŸèƒ½ï¼š** Pydanticæ¨¡å‹ï¼Œå®šä¹‰äº† `create_extraction_chain` åº”è¯¥ä»åˆåŒä¸­æå–å“ªäº›å­—æ®µï¼ˆä¾‹å¦‚ `monthly_rent`ï¼‰ã€‚

* **`calculate_rent_tool(query)`**
    * **åŠŸèƒ½ï¼š** ä¸€ä¸ªç®€å•çš„å·¥å…·ï¼Œè¢« `agent` ç”¨æ¥æ‰§è¡Œæ•°å­¦è®¡ç®—ã€‚
