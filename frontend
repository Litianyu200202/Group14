import streamlit as st
import requests
import pandas as pd
import time
import os

# -------------------------
# ğŸ¨ Page and Style Settings
# -------------------------
st.set_page_config(
    page_title="ğŸ  Tenant Chatbot Frontend",
    page_icon="ğŸ¤–",
    layout="wide",
    initial_sidebar_state="expanded"
)

# -------------------------
# ğŸ’… Classic Chat UI Styling + Left-Right Layout
# -------------------------
st.markdown("""
<style>
body {
    background-color: #f7f7f8;
    font-family: 'Segoe UI', 'Helvetica', 'PingFang SC', sans-serif;
}

.main-header {
    font-size: 2.2rem;
    color: #2c3e50;
    text-align: center;
    margin-bottom: 1.2rem;
    font-weight: 600;
}

/* chat rows */
.chat-row {
    display: flex;
    align-items: flex-start;
    margin: 0.6rem 0;
}

/* left (user question) */
.chat-row.user {
    justify-content: flex-start;
}

/* right (assistant answer) */
.chat-row.assistant {
    justify-content: flex-end;
}

/* bubble style */
.chat-bubble {
    max-width: 70%;
    padding: 0.8rem 1rem;
    border-radius: 14px;
    line-height: 1.5;
    box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    white-space: pre-wrap;
    font-size: 1rem;
}

.user-bubble {
    background-color: #e9f2ff;
    border: 1px solid #d6e6ff;
    color: #1a1a1a;
}

.assistant-bubble {
    background-color: #f1f3f4;
    border: 1px solid #e0e0e0;
    color: #2c2c2c;
}

/* Sidebar */
section[data-testid="stSidebar"] {
    background-color: #fafafa;
    border-right: 1px solid #e0e0e0;
}
</style>
""", unsafe_allow_html=True)

# -------------------------
# ğŸŒ Backend API Endpoints
# -------------------------
API_BASE = "https://group14-1.onrender.com" 
API_CHAT_URL = f"{API_BASE}/chat"
API_USER_URL = f"{API_BASE}/user"
API_REGISTER_URL = f"{API_BASE}/register"
API_UPLOAD_URL = f"{API_BASE}/upload"
API_FEEDBACK_URL = f"{API_BASE}/feedback"
API_MAINTENANCE_URL = f"{API_BASE}/maintenance"

# -------------------------
# Initialize Session State
# -------------------------
if "messages" not in st.session_state:
    st.session_state.messages = []
if "logged_in" not in st.session_state:
    st.session_state.logged_in = False
if "user_info" not in st.session_state:
    st.session_state.user_info = {}
if "contract_summary" not in st.session_state:
    st.session_state.contract_summary = None
if "show_maintenance_form" not in st.session_state:
    st.session_state.show_maintenance_form = False


# ======================================================
# â­ Fullscreen Login / Register Page
# ======================================================
def show_login_page():
    st.markdown("""
    <style>
    .login-container {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 90vh;
    }
    .login-box {
        background-color: white;
        padding: 3rem;
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        width: 400px;
        text-align: center;
    }
    .login-title {
        font-size: 2rem;
        font-weight: 700;
        margin-bottom: 1.2rem;
        color: #2c3e50;
    }
    </style>
    """, unsafe_allow_html=True)

    st.markdown('<div class="login-container"><div class="login-box">', unsafe_allow_html=True)
    st.markdown('<div class="login-title">ğŸ  Tenant Assistant</div>', unsafe_allow_html=True)
    st.markdown("Welcome! Please login or register to continue.")
    mode = st.radio("Select mode", ["Login", "Register"], horizontal=True)

    if mode == "Login":
        email = st.text_input("ğŸ“§ Email Address")
        if st.button("Login"):
            if email:
                try:
                    response = requests.get(API_USER_URL, params={"email": email}, timeout=10)
                    if response.status_code == 200:
                        user_data = response.json()
                        if "user_id" in user_data:
                            st.session_state.user_info = user_data
                            st.session_state.logged_in = True
                            st.success(f"âœ… Welcome back, {user_data.get('name', 'User')} ğŸ‘‹")
                            st.rerun()
                        else:
                            st.error("âš ï¸ Invalid response from backend.")
                    else:
                        st.error("âš ï¸ User not found.")
                except Exception as e:
                    st.error(f"âŒ Could not connect to backend: {e}")
            else:
                st.warning("Please enter your email.")
    else:
        name = st.text_input("ğŸ‘¤ Full Name")
        email = st.text_input("ğŸ“¨ Email (used as login ID)")
        if st.button("Register"):
            if name and email:
                try:
                    payload = {"tenant_id": email, "user_name": name}
                    response = requests.post(API_REGISTER_URL, data=payload, timeout=10)
                    if response.status_code == 200:
                        result = response.json()
                        if result.get("success", True):
                            st.success("âœ… Registration successful! Logging in...")
                            st.session_state.logged_in = True
                            st.session_state.user_info = {"user_id": email, "name": name}
                            st.rerun()
                        else:
                            st.warning("âš ï¸ Registration failed â€” this email may already exist.")
                    else:
                        st.error("âŒ Server error during registration.")
                except Exception as e:
                    st.error(f"âŒ Could not connect to backend: {e}")
            else:
                st.warning("Please fill in both name and email fields.")
    st.markdown('<hr><small style="color:gray;">Â© 2025 Tenant Assistant | Streamlit App</small>', unsafe_allow_html=True)
    st.markdown('</div></div>', unsafe_allow_html=True)


# ======================================================
# ğŸ§­ ROUTER
# ======================================================
if not st.session_state.logged_in:
    show_login_page()
    st.stop()


# ======================================================
# ğŸš€ Chat Interface
# ======================================================
st.markdown('<h1 class="main-header">ğŸ  Tenant Chatbot Assistant</h1>', unsafe_allow_html=True)

# Sidebar
with st.sidebar:
    st.header("ğŸ”§ Settings")
    st.markdown("---")
    name = st.session_state.user_info.get("name", "User")
    st.success(f"ğŸ‘‹ Hello, {name}!")
    if st.button("Logout"):
        for key in list(st.session_state.keys()):
            del st.session_state[key]
        st.rerun()

    st.markdown("---")

    uploaded_file = st.file_uploader("ğŸ“„ Upload Contract PDF", type=["pdf"])
    if uploaded_file:
        with st.spinner("ğŸ“š Processing your contract..."):
            try:
                data = {"tenant_id": st.session_state.user_info.get("user_id")}
                response = requests.post(API_UPLOAD_URL, data=data, files={"file": uploaded_file})
                if response.status_code == 200:
                    res = response.json()
                    st.session_state.contract_summary = res.get("summary", {})
                    st.success("âœ… Contract processed!")
                else:
                    st.error(f"âš ï¸ Upload failed: {response.status_code}")
            except Exception as e:
                st.error(f"âŒ Error: {e}")

    if st.button("ğŸ—‘ï¸ Clear Chat History"):
        st.session_state.messages = []
        st.success("Chat cleared!")

# ======================================================
# ğŸ’¬ Display Chat (left-right)
# ======================================================
for msg in st.session_state.messages:
    if msg["role"] == "user":
        st.markdown(
            f"""
            <div class="chat-row user">
                <div class="chat-bubble user-bubble">ğŸ‘¤ {msg["content"]}</div>
            </div>
            """, unsafe_allow_html=True)
    else:
        st.markdown(
            f"""
            <div class="chat-row assistant">
                <div class="chat-bubble assistant-bubble">ğŸ¤– {msg["content"]}</div>
            </div>
            """, unsafe_allow_html=True)

# ======================================================
# ğŸ’¬ Chat Input
# ======================================================
user_input = st.chat_input("Type your message here...")

# ======================================================
# ğŸš€ Send Logic (with Thinking animation)
# ======================================================
if user_input:
    # Add user message (left)
    st.session_state.messages.append({"role": "user", "content": user_input})
    # Add temporary "Thinkingâ€¦" (right)
    st.session_state.messages.append({"role": "assistant", "content": "ğŸ¤” Thinking..."})
    st.experimental_rerun()

if st.session_state.messages and st.session_state.messages[-1]["content"] == "ğŸ¤” Thinking...":
    # Simulate backend request
    last_user_msg = st.session_state.messages[-2]["content"]
    try:
        payload = {
            "tenant_id": st.session_state.user_info.get("user_id", "Guest"),
            "message": last_user_msg
        }
        response = requests.post(API_CHAT_URL, data=payload, timeout=20)
        if response.status_code == 200:
            data = response.json()
            ai_reply = data.get("reply", "No response found.")
        else:
            ai_reply = f"âš ï¸ Backend returned error: {response.status_code}"
    except Exception as e:
        ai_reply = f"âŒ Could not connect to backend: {e}"

    # Replace "Thinkingâ€¦" with actual reply
    st.session_state.messages[-1] = {"role": "assistant", "content": ai_reply}
    st.experimental_rerun()


